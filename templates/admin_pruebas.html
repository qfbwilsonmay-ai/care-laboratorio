<!DOCTYPE html>
<html>
<head>
    <title>Administrar Pruebas - CARE</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        h1 { 
            color: #0066cc; 
            margin-bottom: 20px; 
        }
        .buscador {
            font-size: 1.1em;
            padding: 12px;
            width: 100%;
            margin-bottom: 20px;
            border: 2px solid #0066cc;
            border-radius: 5px;
            box-sizing: border-box;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td { 
            padding: 12px; 
            border: 1px solid #ccc; 
            text-align: left;
        }
        th { 
            background: #0066cc; 
            color: white; 
        }
        input, select { 
            width: 100%; 
            padding: 8px; 
            margin: 0; 
            box-sizing: border-box; 
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button { 
            padding: 8px 12px; 
            margin: 2px; 
            cursor: pointer; 
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .btn-guardar { 
            background: #28a745; 
            color: white; 
        }
        .btn-eliminar { 
            background: #d9534f; 
            color: white; 
        }
        .btn { 
            background: #007bff; 
            color: white; 
            padding: 10px 15px; 
            text-decoration: none; 
            margin: 5px 0; 
            display: inline-block; 
            border-radius: 4px;
        }
        .contenedor {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <h1>Administrar Pruebas Clínicas</h1>
        <a href="/" class="btn">← Inicio</a>
        <a href="/admin/precios" class="btn">Administrar Precios</a>
<button type="button" class="btn" onclick="agregarFila()">+ Agregar Nueva Prueba</button>

        <!-- Buscador -->
        <input type="text" id="buscador" class="buscador" placeholder="Buscar por clave o nombre de prueba..." onkeyup="buscarPruebas()">

        <form method="POST" id="formPruebas">
            <table id="tablaPruebas">
                <thead>
                    <tr>
                        <th>Clave</th>
                        <th>Nombre</th>
                        <th>Tipo Muestra</th>
                        <th>Contenedor</th>
                        <th>Unidad</th>
                        <th>Valores Normales</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in pruebas %}
                    <tr class="prueba-item" data-clave="{{ p.clave|lower }}" data-nombre="{{ p.nombre|lower }}">
                        <td><input type="text" name="clave_{{ loop.index }}" value="{{ p.clave }}" required></td>
                        <td><input type="text" name="nombre_{{ loop.index }}" value="{{ p.nombre }}" required></td>
                        <td><input type="text" name="tipo_muestra_{{ loop.index }}" value="{{ p.tipo_muestra }}" required></td>
                        <td>
                            <select name="id_contenedor_{{ loop.index }}" required>
                                {% for c in contenedores %}
                                <option value="{{ c.id }}" {% if c.id == p.id_contenedor %}selected{% endif %}>{{ c.nombre }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="text" name="unidad_{{ loop.index }}" value="{{ p.unidad }}" required></td>
                        <td><input type="text" name="valores_normales_{{ loop.index }}" value="{{ p.valores_normales }}" required></td>
                        <td>
                            <button type="button" class="btn-eliminar" onclick="eliminarFila(this)">Eliminar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn-guardar">Guardar Todas las Pruebas</button>
        </form>
    </div>

    <script>
        // Filtro en tiempo real por clave o nombre
        function buscarPruebas() {
            const input = document.getElementById('buscador');
            const filter = input.value.toLowerCase().trim();
            const filas = document.getElementsByClassName('prueba-item');

            if (filter === '') {
                // Mostrar todas si está vacío
                for (let i = 0; i < filas.length; i++) {
                    filas[i].style.display = '';
                }
                return;
            }

            for (let i = 0; i < filas.length; i++) {
                const clave = filas[i].getAttribute('data-clave');
                const nombre = filas[i].getAttribute('data-nombre');
                if (clave.includes(filter) || nombre.includes(filter)) {
                    filas[i].style.display = '';
                } else {
                    filas[i].style.display = 'none';
                }
            }
        }

        // Eliminar fila
        function eliminarFila(btn) {
            if (confirm('¿Seguro que deseas eliminar esta prueba?')) {
                const fila = btn.closest('tr');
                fila.remove();
            }
        }

        // Mostrar todas las pruebas al cargar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const allPruebas = document.querySelectorAll('.prueba-item');
                allPruebas.forEach(el => el.style.display = '');
            }, 100);
        });
// Índice para nuevas filas
let indiceNuevaFila = {{ pruebas | length }} + 1;

// Función para agregar una nueva fila
function agregarFila() {
    const tbody = document.querySelector('#tablaPruebas tbody');
    const tr = document.createElement('tr');
    tr.className = 'prueba-item';
    tr.setAttribute('data-clave', '');
    tr.setAttribute('data-nombre', '');

    tr.innerHTML = `
        <td><input type="text" name="clave_${indiceNuevaFila}" required></td>
        <td><input type="text" name="nombre_${indiceNuevaFila}" required></td>
        <td><input type="text" name="tipo_muestra_${indiceNuevaFila}" required></td>
        <td>
            <select name="id_contenedor_${indiceNuevaFila}" required>
                {% for c in contenedores %}
                <option value="{{ c.id }}">{{ c.nombre }}</option>
                {% endfor %}
            </select>
        </td>
        <td><input type="text" name="unidad_${indiceNuevaFila}" required></td>
        <td><input type="text" name="valores_normales_${indiceNuevaFila}" required></td>
        <td>
            <button type="button" class="btn-eliminar" onclick="eliminarFila(this)">Eliminar</button>
        </td>
    `;

    tbody.appendChild(tr);
    indiceNuevaFila++;
}
    </script>
</body>
</html>