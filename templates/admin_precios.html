<!DOCTYPE html>
<html>
<head>
    <title>Administrar Precios - CARE</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 12px; margin: 2px; cursor: pointer; }
        .btn-guardar { background: #28a745; color: white; border: none; }
        .btn-editar { background: #007bff; color: white; border: none; }
        .btn-validar { background: #ffc107; color: black; border: none; }
        .fila-validada { background-color: #d4edda; }
        .fila-normal { background-color: white; }
        .sugerido { font-weight: bold; color: #0066cc; }
        .con-iva { color: #28a745; font-weight: bold; }
        .btn { background: #007bff; color: white; padding: 8px 16px; text-decoration: none; margin: 5px; }
    </style>
</head>
<body>
    <h1>Administrar Precios por Laboratorio</h1>
    <a href="/" class="btn">← Inicio</a>
    <a href="/admin/pruebas" class="btn">Administrar Pruebas</a>

<!-- Buscador -->
<input type="text" id="buscadorPrecios" class="buscador" placeholder="Buscar por clave o nombre de prueba..." onkeyup="filtrarTablaPrecios()">

<script>
    function filtrarTablaPrecios() {
    const input = document.getElementById('buscadorPrecios');
    const filter = input.value.toLowerCase().trim();
    const filas = document.querySelectorAll('#tablaPrecios tbody tr');

    if (filter === '') {
        // Mostrar todas si está vacío
        filas.forEach(el => el.style.display = '');
        return;
    }

    filas.forEach(fila => {
        // La clave está en la primera celda (td[0])
        // El nombre está en la segunda celda (td[1])
        const celdas = fila.querySelectorAll('td');
        if (celdas.length < 2) return; // Saltar filas sin datos

        const clave = celdas[0].textContent.toLowerCase();
        const nombre = celdas[1].textContent.toLowerCase();

        if (clave.includes(filter) || nombre.includes(filter)) {
            fila.style.display = '';
        } else {
            fila.style.display = 'none';
        }
    });
}

</script>

    <form method="POST" id="formPrecios">
        <table id="tablaPrecios">
            <tr>
    <th rowspan="2">Clave estudio</th>
    <th rowspan="2">Nombre estudio</th>
    <th colspan="2" style="text-align:center; background:#007bff; color:white;">Procesamiento</th>
    <th colspan="2" style="text-align:center; background:#28a745; color:white;">Costos Matriz</th>
    <th colspan="2" style="text-align:center; background:#dc3545; color:white;">Costos Sigma</th>
    <th colspan="2" style="text-align:center; background:#ffc107; color:black;">Ganancia 60%</th>
    <th colspan="2" style="text-align:center; background:#17a2b8; color:white;">Precio público sugerido</th>
    <th colspan="2" style="text-align:center; background:#6f42c1; color:white;">Precio final</th>
    <th colspan="2" style="text-align:center; background:#fd7e14; color:white;">Precio final con IVA</th>
    <th rowspan="2">IVA</th>
    <th rowspan="2">Acciones</th>
</tr>
<tr>
    <th>Matriz</th>
    <th>SIGMA</th>
    <th>Maquila</th>
    <th>Envío</th>
    <th>Maquila</th>
    <th>Envío</th>
    <th>Matriz</th>
    <th>SIGMA</th>
    <th>Matriz</th>
    <th>SIGMA</th>
    <th>Matriz</th>
    <th>SIGMA</th>
    <th>Matriz</th>
    <th>SIGMA</th>
    <th>Matriz</th>
    <th>SIGMA</th>
</tr>

<!-- Cambio forzado para que Git lo detecte -->

            {% for p in pruebas %}
            {% set precio = precios_dict.get('prueba_' + p.clave) or {} %}
            {% set costos = precio.costos or {} %}
            {% set matriz = costos.matriz or {} %}
            {% set sigma = costos.sigma or {} %}<form method="POST" id="formPrecios">
            {% set validado = precio.validado or false %}
            {% set clase_fila = "fila-validada" if validado else "fila-normal" %}

            <tr class="{{ clase_fila }}" id="fila_{{ loop.index }}">
    <td>{{ p.clave }}</td>
<td>
    {{ p.nombre }}
    <input type="hidden" name="tipo_{{ loop.index }}" value="prueba">
    <input type="hidden" name="id_{{ loop.index }}" value="{{ p.clave }}">
    <input type="hidden" name="validado_{{ loop.index }}" id="validado_{{ loop.index }}" value="{{ '1' if validado else '0' }}">
</td>
    <!-- Procesamiento -->
    <td><input type="checkbox" name="procesa_matriz_{{ loop.index }}" checked onchange="actualizarCampos({{ loop.index }})"></td>
    <td><input type="checkbox" name="procesa_sigma_{{ loop.index }}" checked onchange="actualizarCampos({{ loop.index }})"></td>
    <!-- Costos Matriz -->
    <td><input type="number" step="0.01" name="maquila_matriz_{{ loop.index }}" value="{{ matriz.maquila if matriz.maquila else 0 }}" class="costo" data-idx="{{ loop.index }}" {{ 'readonly' if validado else '' }}></td>
    <td><input type="number" step="0.01" name="envio_matriz_{{ loop.index }}" value="{{ matriz.envio if matriz.envio else 0 }}" class="costo" data-idx="{{ loop.index }}" {{ 'readonly' if validado else '' }}></td>
    <!-- Costos SIGMA -->
    <td><input type="number" step="0.01" name="maquila_sigma_{{ loop.index }}" value="{{ sigma.maquila if sigma.maquila else 0 }}" class="costo" data-idx="{{ loop.index }}" {{ 'readonly' if validado else '' }}></td>
    <td><input type="number" step="0.01" name="envio_sigma_{{ loop.index }}" value="{{ sigma.envio if sigma.envio else 0 }}" class="costo" data-idx="{{ loop.index }}" {{ 'readonly' if validado else '' }}></td>
    <!-- Ganancia (60%) -->
    <td class="sugerido" id="ganancia_matriz_{{ loop.index }}">{{ "%.2f"|format((matriz.maquila + matriz.envio) * 0.6 if matriz.maquila else 0) }}</td>
    <td class="sugerido" id="ganancia_sigma_{{ loop.index }}">{{ "%.2f"|format((sigma.maquila + sigma.envio) * 0.6 if sigma.maquila else 0) }}</td>
    <!-- Precio Público Sugerido -->
    <td class="sugerido" id="precio_sugerido_matriz_{{ loop.index }}">{{ "%.2f"|format((matriz.maquila + matriz.envio) * 1.6 if matriz.maquila else 0) }}</td>
    <td class="sugerido" id="precio_sugerido_sigma_{{ loop.index }}">{{ "%.2f"|format((sigma.maquila + sigma.envio) * 1.6 if sigma.maquila else 0) }}</td>
    <!-- Precio Final -->
    <td><input type="number" step="0.01" name="precio_final_matriz_{{ loop.index }}" value="{{ precio.precio_publico_matriz if precio.precio_publico_matriz else 0 }}" required {{ 'readonly' if validado else '' }} onchange="calcularConIVAFinal(this, 'precio_final_con_iva_matriz_{{ loop.index }}', 'iva_matriz_{{ loop.index }}')"></td>
    <td><input type="number" step="0.01" name="precio_final_sigma_{{ loop.index }}" value="{{ precio.precio_publico_sigma if precio.precio_publico_sigma else 0 }}" required {{ 'readonly' if validado else '' }} onchange="calcularConIVAFinal(this, 'precio_final_con_iva_sigma_{{ loop.index }}', 'iva_sigma_{{ loop.index }}')"></td>
    <!-- Precio Final con IVA -->
    <td class="con-iva" id="precio_final_con_iva_matriz_{{ loop.index }}">{{ "%.2f"|format((precio.precio_publico_matriz * 1.16) if precio.precio_publico_matriz else 0) }}</td>
    <td class="con-iva" id="precio_final_con_iva_sigma_{{ loop.index }}">{{ "%.2f"|format((precio.precio_publico_sigma * 1.16) if precio.precio_publico_sigma else 0) }}</td>
    <!-- IVA -->
    <td class="con-iva" id="iva_matriz_{{ loop.index }}">{{ "%.2f"|format((precio.precio_publico_matriz * 0.16) if precio.precio_publico_matriz else 0) }}</td>
    <!-- Acciones -->
    <td>
        {% if validado %}
            <button type="button" class="btn-editar" onclick="editarFila({{ loop.index }})">Editar</button>
        {% else %}
            <button type="button" class="btn-validar" onclick="validarFila({{ loop.index }})">Validar</button>
        {% endif %}
    </td>
</tr>
            {% endfor %}
        </table>
        <button type="submit" class="btn-guardar">Guardar Todos los Precios</button>
    </form>

    <p><strong>Estado:</strong> Fila verde = validada. Fila blanca = pendiente.</p>

    <script>
        // Calcular precios sugeridos al escribir
        // Calcular precios sugeridos al escribir
function calcularSugeridos(idx) {
    const maquilaMatriz = parseFloat(document.querySelector(`[name="maquila_matriz_${idx}"]`).value) || 0;
    const envioMatriz = parseFloat(document.querySelector(`[name="envio_matriz_${idx}"]`).value) || 0;
    const maquilaSigma = parseFloat(document.querySelector(`[name="maquila_sigma_${idx}"]`).value) || 0;
    const envioSigma = parseFloat(document.querySelector(`[name="envio_sigma_${idx}"]`).value) || 0;

    const costoMatriz = maquilaMatriz + envioMatriz;
    const costoSigma = maquilaSigma + envioSigma;

    // Ganancia del 60% (fija)
    const gananciaMatriz = (costoMatriz * 0.6).toFixed(2);
    const gananciaSigma = (costoSigma * 0.6).toFixed(2);

    // Precio sugerido = costo + 60% de ganancia
    const precioSugeridoMatriz = (costoMatriz * 1.6).toFixed(2);
    const precioSugeridoSigma = (costoSigma * 1.6).toFixed(2);

    // Actualizar en pantalla
    document.getElementById(`ganancia_matriz_${idx}`).textContent = gananciaMatriz;
    document.getElementById(`ganancia_sigma_${idx}`).textContent = gananciaSigma;
    document.getElementById(`precio_sugerido_matriz_${idx}`).textContent = precioSugeridoMatriz;
    document.getElementById(`precio_sugerido_sigma_${idx}`).textContent = precioSugeridoSigma;
}

function actualizarCampos(idx) {
    const procesaMatriz = document.querySelector(`[name="procesa_matriz_${idx}"]`).checked;
    const procesaSigma = document.querySelector(`[name="procesa_sigma_${idx}"]`).checked;

    const inputsMatriz = document.querySelectorAll(`[name="maquila_matriz_${idx}"], [name="envio_matriz_${idx}"], [name="precio_final_matriz_${idx}"]`);
    const inputsSigma = document.querySelectorAll(`[name="maquila_sigma_${idx}"], [name="envio_sigma_${idx}"], [name="precio_final_sigma_${idx}"]`);

    inputsMatriz.forEach(input => {
        input.disabled = !procesaMatriz;
    });

    inputsSigma.forEach(input => {
        input.disabled = !procesaSigma;
    });
}

function calcularConIVAFinal(input, idConIVA, idIVA) {
    const precio = parseFloat(input.value) || 0;
    const precioConIVA = precio * 1.16;
    const iva = precio * 0.16;
    document.getElementById(idConIVA).textContent = precioConIVA.toFixed(2);
    document.getElementById(idIVA).textContent = iva.toFixed(2);
}

        // Validar fila: bloquea campos y pone verde
        function validarFila(idx) {
            const inputs = document.querySelectorAll(`#fila_${idx} input`);
            inputs.forEach(input => {
                if (input.name.startsWith('precio_publico_')) return;
                input.setAttribute('readonly', 'readonly');
            });
            document.getElementById(`fila_${idx}`).classList.add('fila-validada');
            document.getElementById(`validado_${idx}`).value = '1';
            document.querySelector(`#fila_${idx} td:last-child`).innerHTML = 
                `<button type="button" class="btn-editar" onclick="editarFila(${idx})">Editar</button>`;
        }

        // Editar fila: desbloquea campos y quita el verde
        function editarFila(idx) {
            const inputs = document.querySelectorAll(`#fila_${idx} input`);
            inputs.forEach(input => {
                if (input.name.startsWith('precio_publico_')) return;
                input.removeAttribute('readonly');
            });
            document.getElementById(`fila_${idx}`).classList.remove('fila-validada');
            document.getElementById(`validado_${idx}`).value = '0';
            document.querySelector(`#fila_${idx} td:last-child`).innerHTML = 
                `<button type="button" class="btn-validar" onclick="validarFila(${idx})">Validar</button>`;
        }


        // Calcular precio con IVA
        function calcularConIVA(input, idConIVA) {
            const precio = parseFloat(input.value) || 0;
            const precioConIVA = precio * 1.16;
            document.getElementById(idConIVA).textContent = precioConIVA.toFixed(2);
        }

        // Escuchar cambios en costos y ganancia
        document.querySelectorAll('input[name^="maquila_"], input[name^="envio_"]').forEach(input => {
    input.addEventListener('input', function() {
        const idx = this.name.split('_')[2];
        calcularSugeridos(idx);
    });
});

        // Calcular todos al cargar
        document.querySelectorAll('.costo').forEach(input => {
            const idx = input.getAttribute('data-idx');
            calcularSugeridos(idx);
        });

        // Calcular precios con IVA iniciales
        document.querySelectorAll('[name^="precio_publico_"]').forEach(input => {
            const idx = input.name.split('_')[3];
            const isMatriz = input.name.includes('matriz');
            const idConIVA = isMatriz ? `precio_con_iva_matriz_${idx}` : `precio_con_iva_sigma_${idx}`;
            calcularConIVA(input, idConIVA);
        });
    </script>
</body>
</html>