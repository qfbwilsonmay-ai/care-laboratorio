<!DOCTYPE html>
<html>
<head>
    <title>Administrar Precios - CARE</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; }
        button { background: #28a745; color: white; padding: 10px 20px; border: none; margin: 10px 0; }
        .btn { background: #007bff; color: white; padding: 8px 16px; text-decoration: none; margin: 5px; }
        .info { font-size: 0.9em; color: #666; }
        .laboratorio { font-weight: bold; color: #0066cc; }
    </style>
</head>
<body>
    <h1>Administrar Precios por Laboratorio</h1>
    <a href="/" class="btn">← Inicio</a>
    <a href="/admin/pruebas" class="btn">Administrar Pruebas</a>

    <form method="POST">
        <table>
            <tr>
                <th>Prueba</th>
                <th colspan="3">Costos - Matriz</th>
                <th colspan="3">Costos - SIGMA</th>
                <th>Ganancia (%)</th>
                <th>Precio Sugerido</th>
                <th>Precio al Público</th>
            </tr>
            <tr>
                <th></th>
                <th>Maquila</th>
                <th>Materiales</th>
                <th>Envío</th>
                <th>Maquila</th>
                <th>Materiales</th>
                <th>Envío</th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
            {% for p in pruebas %}
            {% set precio = precios_dict.get('prueba_' + p.clave) or {} %}
            {% set costos = precio.costos or {} %}
            {% set matriz = costos.matriz or {} %}
            {% set sigma = costos.sigma or {} %}
            <tr>
                <td>
                    {{ p.nombre }}
                    <input type="hidden" name="tipo_{{ loop.index }}" value="prueba">
                    <input type="hidden" name="id_{{ loop.index }}" value="{{ p.clave }}">
                </td>
                <!-- Costos Matriz -->
                <td><input type="number" step="0.01" name="maquila_matriz_{{ loop.index }}" value="{{ matriz.maquila if matriz.maquila else 0 }}"></td>
                <td><input type="number" step="0.01" name="materiales_matriz_{{ loop.index }}" value="{{ matriz.materiales if matriz.materiales else 0 }}"></td>
                <td><input type="number" step="0.01" name="envio_matriz_{{ loop.index }}" value="{{ matriz.envio if matriz.envio else 0 }}"></td>
                <!-- Costos SIGMA -->
                <td><input type="number" step="0.01" name="maquila_sigma_{{ loop.index }}" value="{{ sigma.maquila if sigma.maquila else 0 }}"></td>
                <td><input type="number" step="0.01" name="materiales_sigma_{{ loop.index }}" value="{{ sigma.materiales if sigma.materiales else 0 }}"></td>
                <td><input type="number" step="0.01" name="envio_sigma_{{ loop.index }}" value="{{ sigma.envio if sigma.envio else 0 }}"></td>
                <!-- Ganancia -->
                <td><input type="number" step="0.1" name="ganancia_{{ loop.index }}" value="{{ precio.ganancia_porcentaje if precio.ganancia_porcentaje else 50 }}" required></td>
                <!-- Precio Sugerido -->
                <td>
                    {% set costo_matriz = (matriz.maquila if matriz.maquila else 0) + (matriz.materiales if matriz.materiales else 0) + (matriz.envio if matriz.envio else 0) %}
                    {% set costo_sigma = (sigma.maquila if sigma.maquila else 0) + (sigma.materiales if sigma.materiales else 0) + (sigma.envio if sigma.envio else 0) %}
                    {% set max_costo = costo_matriz if costo_matriz > costo_sigma else costo_sigma %}
                    {% set sugerido = (max_costo * (1 + (precio.ganancia_porcentaje if precio.ganancia_porcentaje else 50) / 100)) | round(2) %}
                    <span>{{ sugerido }}</span>
                </td>
                <!-- Precio Público -->
                <td><input type="number" step="0.01" name="precio_publico_{{ loop.index }}" value="{{ precio.precio_publico if precio.precio_publico else sugerido }}" required></td>
            </tr>
            {% endfor %}
        </table>
        <button type="submit">Guardar Precios</button>
    </form>

    <p class="info">
        <strong>Precio sugerido:</strong> Se calcula con el costo más alto (matriz o SIGMA) aplicando la ganancia.<br>
        <strong>Tú decides el precio final</strong> en "Precio al Público".
    </p>
</body>
</html>